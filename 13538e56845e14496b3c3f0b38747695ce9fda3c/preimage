=encoding utf8

=head1 NAME

perlcdelta - what is new for cperl v5.24.0

=head1 DESCRIPTION

This document describes perl-only differences between the cperl 5.22.3
release and the cperl 5.24.0 release.

=head1 Core Enhancements

=over 4

=item * Keep the lexical topic feature

Undo the removal of lexical topic. We fixed that in 5.22.2c already, and
it is critically needed for given/when, smartmatch.

=item * Proper signatures

Support builtin and efficient signatures, with types and references (call-by-ref).
goto to a signatured function is now a true tail call, reusing the old padframe
variables without copying.

See L<perlsub/Signatures> and L<perlfunc/prototype>.

The C<prototype> function returns the parsed string of a declared
signature if no prototype attribute overrides it.

The C<@_> array inside a function body with a signature is empty. With
default parameters there's is currently no way to find out how many
actual arguments were provided, and how many were filled out with
defaults.
L<[cperl #7]|https://github.com/perl11/cperl/issues/7>
L<[cperl #134]|https://github.com/perl11/cperl/issues/134>

Many subroutines of the form C<my ($args...) = @_;>
are automatically converted via L<fake_signatures>
to use signatures internally.

=item * Less experimental needed

Remove the previously required use experimental for
C<lexical_topic>, C<smartmatch>.
C<given>/C<when> is now standard cperl syntax.

Note that C<postderef> and C<autoderef> were removed by perl5.

=item * Improved fast arithmetic

The compile-time C<u_{add,subtract,multiply}> op variants for constant folding
have now proper overflowing behaviour, and are now also used with 32bit.
L<[cperl #2]|https://github.com/perl11/cperl/issues/2>

=item * keep CxFOREACHDEF removed with perl-5.24.0

API macro to check for a loop with default var (gv or pad C<$_>).
Added with 5.9.3 by Robin Houston when he added given/when.
Deleted with 5.24.0, without any deprecation or mention.

=item * 2 new OP members

C<op_rettype> was added and C<op_typechecked> taken from a spare bit.

=item * many new public symbols needed for the compiler

unshare_hek, mro_isa_changed_in, sv_clean_objs,
win32_wait_for_children, PerlIO_cleanup, PerlIO_destruct

Fixed the generated perldll.def (makedef.pl)

=item * better -Dt tracing

Many ops print now their arguments: signature, padrange, entersub,
enterxssub, method_named

=back

=head1 Core Enhancements from Perl5

Backported some fixes from p5p, merged with perl-5.24.0.
L<[cperl #137]|https://github.com/perl11/cperl/issues/137>

=over 4

=item * ~20% performance improvements with a CX context system rewrite

=item * DESTROY cache moved back from the stash to mro_meta

So we don't need our special B::SvSTASH fixes anymore.

=back

=head1 Security

=head2 DynaLoader format string hardening

Replace all C<%> characters in user-controlled library filenames, passed via
the system dl_error call verbatim to C<printf>, without any arguments on the stack,
which could lead to execution of arbitrary stack code. No CVE.
This affects all systems with dynamic loading where the attacker can cause a
dynamic loading error.

CVSSv2 Severity: 7.2 (AV:L/AC:L/Au:N/C:C/I:C/A:C/E:U/RL:OF/RC:C/CDP:MH/TD:H/CR:H/IR:H/AR:ND)

=head1 Modules and Pragmata

=head2 New Modules and Pragmata

=over 4

=item fake_signatures 0.01

Prohibit the automatic conversion to fake signatures via
C<no fake_signatures>, and document the new conversion of argument handling
to fake signatures.  See L<fake_signatures>.

=back

=head2 Updated Modules and Pragmata

Many internal core modules are now half-way "modernized", i.e.
use typed signatures, and catch errors at compile-time.
L<[cperl #97]|https://github.com/perl11/cperl/issues/97>

But no classes, methods and roles yet.

=over 4

=item Socket 2.021_02

Silence some CC warnings

Fix my to our $XS_VERSION

Check for max length before derefing by length (jhi) RT #111707

=item DynaLoader 2.04c

See L</DynaLoader format string hardening> above.

=item B::C 1.54_07

Many Windows fixes, for the old MSVC compiler, and PERL_CORE test
integration. Use many new core exports needed for windows.

Update perlcc to 2.21, handle multiple -I and -L arguments.

Handle cperl OP_SIGNATURE.

Fix refcount of cop hints hashes with 5.22-nt (#220)

Better UVX L and U suffices.

Handle shared IV and UV xpv structs,
  fixed 5.24 specific assertions, with shared xpviv/xpvuv.
  fixed wrong 32 bit ptr offset. re-enabled all 32bit tests.

Handle changed subdirs-test target with newer EUMM.

=item B::Deparse 1.37_02c

Add more cperl-specific ops: aelem*_u, u_{add,subtract,multiply},
{i,n,s}_aelem{,_u}

=item Test::Simple 1.401014c

Based on 1.001014, not Test2 as in 1.302022 yet. Test2 breaks too many
modules still, and I need to time to properly modernize it (as v2.x)

Modernized and stricter type checks.
B<skip> does the switched argument check at compile-time.
See the FAQ at L<http://perl11.org/cperl/STATUS.html> why we enforce
stricter types there.

Enable t/is_deeply_with_threads.t

=item File-Path 3.12_01c

Modernized. Enforce many str types.

=item PathTools 4.63c

Modernized. Enforce many str types.

Enable XS prototypes and suppress warnings. #152

Disallow the optional getcwd argument (5.8.5 problem).
  Cannot be called as method.

=item Pod-Simple 4.30c

Modernized

=item Pod-Html 2.22c

Modernized

=item bignum 0.42c

Modernized

=item bigint 0.43c

Modernized.
Fixed deprecated usage of ::binf, ::bnan as function.

=item bigrat 0.42c

Modernized

=item CPAN

Fixed tests. Type skip calls and File-Path args.

Change FirstTime yaml_module default from YAML to YAML::XS
and prohibit the unsupported CPAN::Meta::YAML.

=item ExtUtils-MakeMaker

Type File-Path args.

=item Parse-CPAN-Meta 1.5000c

Modernized.
str type for skip

=item CPAN-Meta 2.150005c

fix Encode test for modernized Test-Simple,
stringify the 1st skip arg

=item CPAN::Meta::Requirements 3.140c

=item Test-Harness 3.36

type the skip calls

=item Hash-Util-FieldHash

type the skip calls

=item YAML-LibYAML 0.70

Spiffy and Test::Base 0.88c fixes for fake signatures.

Spiffy uses a source filter to expand many methods,
but this does not work with fake_signatures.
Expand the compile-time state of Test::Base to avoid
source filters.
Also add . to @INC in some tests.

utf-8 handling stills throws many warnings.

=item Filter-Util-Call 0.92

Fixed 1 test for signature errmsg

=item IO-Compress

Fixed 1 test for signature errmsg

=item Devel-Peek 1.23

Skip tests for changed dynamic prototype() with sigs.
Fix tests with -DDEBUG_LEAKING_SCALARS

=item B 1.62_02

add B::OP::rettype, B::OP::typechecked,
B::CV::SIGOP and support for OP_SIGNATURE with B::UNOP_AUX::aux_list
and B::UNOP_AUX::string.

Note: With threads in B::UNOP_AUX::aux_list the padoffsets are returned as such,
and not as SV. This is different to upstream perl5, a perl5 bug.

=item Devel-NYTProf 6.03

fix test for short CV_NAME_NOMAIN.
silence a C compiler warning.

=item perl5db 1.49_04c

fix test for short CV_NAME_NOMAIN.
run-time load IO::Handle, broke miniperl.
handle calls to signatures via goto, and add tests.

=item Digest::MD5 2.55_01

=item warnings 1.35

Add category C<types>.

Disable 3 experimental warnings which are now default with cperl.

<<<<<<<
=item Archive::Tar 2.08

Added t/09_roundtrip.t

=item Config 6.20

Various minor fixes

=item Config::Perl::V 0.26_01

cperl patches.
Add tests for 5.22 and 5.24.
Support some multi-line keys: ccflags ldflags lddlflags
Changed tests to use done_testing().

=item Cpanel::JSON::XS 3.0216

- Fix wrong test 117 (pghmcfc)

- TODO the fragile mojo boolean interop test.

- Improve error message with class based method calls,
  when forgetting ->new. #66

- Fix a off-by-one IV_MIN -> NV overflow in decode_json. #67 (xdg)

- Avoid encode_sv SEGV with -Dusequadmath #62
  Fix quadmath NV stringification.

=item DB_File 1.838

Skip checking the return status of the api calls.

=item Devel::PPPort 3.33_02

Support the latest versions.

cperl specific:
Minor -Dfortify_inc fixes, kept our Hv macros,
fix __attribute__((warn_unused_result)) on windows.

=item HTTP::Tiny 0.058

Added some methods.

=item IPC::SysV 2.07

Sync with upstream, they fixed
https://rt.cpan.org/Public/Bug/Display.html?id=112827

=item JSON::PP 2.27400

Some fixes.
Kept our cperl-specific fallbacks to
Cpanel::JSON::XS and boolean interop.

=item Locale::Codes 3.39

Removed the deprecated C<alias_code> subroutine.
Added some LOCALE_CODE_* UN and GENC constants.

=item Math::BigInt 1.999722

Many changes.
Fixed a skip count/why mixup in F<t/mbimbf.inc>, detected by cperl.

=item Math::BigInt::FastCalc 0.42

No changes.

=item Math::BigRat 0.260804

Many changes.

=item Module-Metadata 1.000031-TRIAL

Fixed the F<t/extract-version.t> TODO tests.

=item libnet 3.08

Keeping our darwin performance fix for hostname

=item Pod::Checker 1.73

Now based on Pod::Simple, not on Pod::Parser anymore.
dos2unix

=item Pod::Functions 1.11

Whitespace only to please the new Pod::Checker

=item Pod::Usage 1.69_01

Remove the Pod::Find test, using pod_where.
dos2unix

=item Sys::Syslog 0.34

Handle F<fallback/syslog.h> properly. honor HAVE_SETLOCALE
fix windows fallback.
Exclude the F<t/facilities-routing.t> test requiring POE.
Skip failing udp tests when the server is overloaded.

=item Time::HiRes 1.9733

Minor changes from 5.22.3c.
Improve t/nanosleep.t to show smoker errors.

=item Thread::Queue 3.11

Replace C<threads::yield> with C<< thread->join >> in F<t/07_lock.t>.

=item threads 2.09

Updated from 2.06. Improve 2 tests

=item threads::shared 1.52

No functional changes

=item Term::ReadKey

Improve Makefile.PL, esp. for Windows.
See L<https://github.com/jonathanstowe/TermReadKey/pull/15>

=======
=item version 0.9916

Add a scmp method for string comparison, needed to destinguish between
0.2 and 0.2c but only enforced if the version object is stringified.
Using eq is not enough.

Fix c suffix comparisons: stringify v0.2c to v0.2c, 0.2c to 0.2c
numify 0.2c to 0.002 [0 200], same as 0.2

>>>>>>>
=back

=head2 Not Updated Modules and Pragmata

This modules are currently not ready to be updated.

=over 4

=item MakeUtils::MakeMaker 7.11_06

Broken for -Dfortify_inc, no "." in @INC.
Broken new "_" logic when merged with our 'c' suffix logic.

=item Test2

We need some time to modernize it, as done with the previous version.

Our Test::Simple and Test::More versions were bumped to 1.4 to prohibit
automatic installation of Test2 from CPAN, to use our improved versions
instead.

=item version 0.9917

Broken new "_" logic when merged with our 'c' suffix logic.

=back

=head1 Platform Support

=head2 Platform-Specific Notes

=over 4

=item Win32

Work is ongoing for perlcc compiler support on Win32. It is now
usable, but not as good as on other platforms.

=item Darwin

With C<-DDEBUGGING> F<dsymutil> is called automatically on all created
binaries for easier debugging.

=back

=head1 Acknowledgements

cperl 5.24.0 represents approximately 2 weeks of development since cperl
5.22.2c and contains approximately 32,000,000 lines of changes across 4,900
files from 53 authors.

Excluding auto-generated files, documentation and release tools, there were
approximately 140,000 lines of changes to 600 .pm, .t, .c and .h files.

The following people are known to have contributed the improvements that became
cperl 5.24.0:

Karl Williamson, David Mitchell, Jarkko Hietaniemi, Andy Broad, Reini Urban,
Tony Cook, Craig A. Berry, Lukas Mai, Aaron Crane, Daniel Dragan, Dagfinn
Ilmari Mannsåker, Steve Hay, Ricardo Signes, James E Keenan, H.Merijn Brand,
Yves Orton, Matthew Horsfall, Aristotle Pagaltzis, Father Chrysostomos, Karen
Etheridge, Abigail, Doug Bell, Chris 'BinGOs' Williams, Stevan Little, Rafael
Garcia-Suarez, Andy Dougherty, Vincent Pit, Todd Rinaldo, Tom Hukins, Thomas
Sibley, Nicholas Clark, Ed J, Mohammed El-Afifi, Mattia Barbon, Shlomi Fish, Ed
Avis, Stanislaw Pusep, Alexander D'Archangel, Ludovic E. R. Tolhurst-Cleaver,
Chas. Owens, Victor Adam, Herbert Breunung, Sisyphus, Achim Gratz, Leon
Timmermans, Aaron Priven, Max Maischein, Dan Collins, Ivan Pozdeev, Peter
Martini, Zachary Storer, Dr.Ruud, John SJ Anderson.

The list above is almost certainly incomplete as it is automatically generated
from version control history including the perl and cperl repos. In particular,
it does not include the names of the (very much appreciated) contributors who
reported issues to the Perl bug tracker and the cperl github issues.

Many of the changes included in this version originated in the CPAN modules
included in Perl's core. We're grateful to the entire CPAN community for
helping Perl to flourish.

For a more complete list of all of Perl's historical contributors, please see
the F<AUTHORS> file in the Perl source distribution.

=head1 Reporting Bugs

If you find what you think is a bug, you might check the articles recently
posted to the comp.lang.perl.misc newsgroup and the perl bug database at
L<https://rt.perl.org/> .  There may also be information at
L<http://www.perl.org/> , the Perl Home Page.

If you believe you have an unreported bug, please run the C<perlbug> program
included with your release.  Be sure to trim your bug down to a tiny but
sufficient test case.  Your bug report, along with the output of C<perl -V>,
will be sent off to C<perlbug@perl.org> to be analysed by the Perl porting team.

If you think it's a cperl specific bug or trust the cperl developers more 
please file an issue at L<https://github.com/perl11/cperl/issues>.

If the bug you are reporting has security implications, which make it
inappropriate to send to a publicly archived mailing list, then please send it
to C<perl5-security-report@perl.org>.  This points to a closed subscription
unarchived mailing list, which includes all the p5p core committers, who will be
able to help assess the impact of issues, figure out a resolution, and help
co-ordinate the release of patches to mitigate or fix the problem across all
platforms on which Perl is supported.  Please only use this address for
security issues in the Perl core, not for modules independently distributed on
CPAN.

If you trust the cperl developers more, please send an email to
them. The p5p security teams skips many security issues, or are
unwilling to fix them.

=head1 SEE ALSO

The F<Changes> file for an explanation of how to view exhaustive details on
what changed.

The F<INSTALL> file for how to build Perl.

The F<README> file for general stuff.

The F<Artistic> and F<Copying> files for copyright information.

=cut
